name: Update Academic Feed

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'config.yml'
      - 'src/**'

jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for committing changes

    # Prevent concurrent runs to avoid merge conflicts
    concurrency:
      group: update-feed
      cancel-in-progress: false  # Let current run finish
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper git operations
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Create directories
      run: |
        mkdir -p data output logs cache
    
    - name: Restore metadata cache
      uses: actions/cache@v3
      with:
        path: cache/
        key: toread-metadata-cache-v2-${{ hashFiles('data/paperpile_export.bib') }}
        restore-keys: |
          toread-metadata-cache-v2-
    
    - name: Download Paperpile export
      run: |
        # Download fresh BibTeX export from Paperpile
        if [ -z "${{ secrets.PAPERPILE_EXPORT_URL }}" ]; then
          echo "Error: PAPERPILE_EXPORT_URL secret is not configured"
          echo "Please add your Paperpile export URL as a GitHub secret"
          exit 1
        fi
        
        echo "Downloading BibTeX export from Paperpile..."
        curl -L "${{ secrets.PAPERPILE_EXPORT_URL }}" -o data/paperpile_export.bib
        
        if [ ! -f "data/paperpile_export.bib" ] || [ ! -s "data/paperpile_export.bib" ]; then
          echo "Error: Failed to download BibTeX file or file is empty"
          exit 1
        fi
        
        echo "Successfully downloaded BibTeX file ($(wc -l < data/paperpile_export.bib) lines)"
    
    - name: Update config with API key
      if: env.SEMANTIC_SCHOLAR_API_KEY != ''
      env:
        SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
      run: |
        python -c "
        import yaml
        with open('config.yml', 'r') as f:
            config = yaml.safe_load(f)
        config['api']['semantic_scholar']['api_key'] = '${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}'
        with open('config.yml', 'w') as f:
            yaml.dump(config, f, default_flow_style=False)
        "
    
    - name: Generate feeds (fast mode for scheduled runs)
      if: github.event_name == 'schedule'
      run: |
        echo "Running in fast mode for scheduled execution..."
        for i in {1..3}; do
          python -m src.main data/paperpile_export.bib -o output/ \
            --feed-title "To Read - Research Papers" \
            --feed-description "Academic papers from Paperpile enriched with metadata" \
            --rate-limit 3.0 --timeout 20 --skip-cached-enrichment && break
          echo "Attempt $i failed, retrying in 30s..."
          sleep 30
        done
    
    - name: Generate feeds (full enrichment)
      if: github.event_name != 'schedule'
      run: |
        echo "Running full enrichment for manual/push triggers..."
        for i in {1..3}; do
          python -m src.main data/paperpile_export.bib -o output/ \
            --feed-title "To Read - Research Papers" \
            --feed-description "Academic papers from Paperpile enriched with metadata" \
            --rate-limit 2.0 --timeout 30 && break
          echo "Attempt $i failed, retrying in 60s..."
          sleep 60
        done
    
    - name: Check for changes
      id: git-check
      run: |
        # Ensure output directory exists and add generated files
        mkdir -p output
        git add output/feed.json output/feed.xml 2>/dev/null || true
        
        # Check if there are any staged changes
        if git diff --staged --quiet; then
          echo "üìã No changes detected in feeds"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "üìã Changes detected in feeds"
          git diff --staged --name-only
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
        
        # Also check for any unstaged changes that might cause issues
        if ! git diff-index --quiet HEAD --; then
          echo "‚ö†Ô∏è  Warning: Unstaged changes detected"
          git status --short
        fi
    
    - name: Commit and push changes
      if: steps.git-check.outputs.changes == 'true'
      shell: bash
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Pull latest changes first to avoid conflicts
        echo "Fetching latest changes before commit..."
        git fetch origin main

        # Reset to latest remote (our generated files will be re-applied)
        echo "Syncing with remote..."
        git reset --soft origin/main

        # Re-add our generated files
        git add output/feed.json output/feed.xml

        # Commit with timestamp
        git commit -m "ü§ñ Update academic feeds - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || {
          echo "No changes to commit after sync"
          exit 0
        }

        # Push with retry logic
        for i in {1..5}; do
          echo "Push attempt $i of 5..."
          if git push origin main; then
            echo "‚úÖ Successfully pushed changes"
            exit 0
          fi

          echo "‚ùå Push failed (attempt $i), likely due to concurrent update"

          # If we're on the last attempt, fail
          if [ $i -eq 5 ]; then
            echo "üö® All push attempts failed - likely concurrent workflow"
            echo "This is expected behavior with concurrency control enabled"
            exit 0  # Exit gracefully, next run will pick up changes
          fi

          # Wait with exponential backoff
          wait_time=$((5 * i))
          echo "Waiting ${wait_time}s before retry..."
          sleep $wait_time

          # Sync again for next attempt
          git fetch origin main
          git reset --soft origin/main
          git add output/feed.json output/feed.xml
          git commit -m "ü§ñ Update academic feeds - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || {
            echo "No new changes after resync"
            exit 0
          }
        done
    
    - name: Upload feeds as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: academic-feeds
        path: output/
        retention-days: 30